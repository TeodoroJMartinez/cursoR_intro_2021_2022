```{r echo = FALSE}
library(knitr)

# Color text
colorize <- function(x, color) {
  
  if (knitr::is_latex_output()) {
    
    sprintf("\\textcolor{%s}{%s}", color, x)
    
  } else if (knitr::is_html_output()) {
    
    sprintf("<span style='color: %s;'>%s</span>", color, x)
    
  } else { x }
}
```

# Fechas {#fechas}

:::: {.blackbox data-latex=""}

Scripts usados:

* [**script08.R**](https://github.com/dadosdelaplace/courses-intro-R/blob/main/scripts/script08.R). Ver en <https://github.com/dadosdelaplace/courses-intro-R/blob/main/scripts/script08.R>

::::


- [X] Variables num√©ricas (individuales)
- [X] Variables de caracteres
- [X] Variables l√≥gicas
- [X] Variables de tipo fecha

Dado que el objetivo final es trabajar con datos, vamos a ver un tipo de datos muy especial: los <mark>**datos de tipo fecha**</mark>. Una fecha podr√≠amos que no tiene nada de especial ya que una simple cadena de texto `"2021-04-21"`. Sin embargo, representa un instante en el tiempo, que deber√≠amos poder operar como tal. ¬øQu√© suceder√≠a si sumamos un `1` (un d√≠a) a una fecha definida como una cadena de texto?

```{r error = TRUE}
# Cadena de texto
fecha_char <- "2021-04-21"
class(fecha_char)
fecha_char + 1
```

Como ves, da error, ya que a un texto no le podemos sumar un n√∫mero (no distingue entre dicha cadena de texto y, por ejemplo, `"oso panda"`). Por suerte contamos con el paquete `{lubridate}`, con diferentes funcionalidades para trabajar con fechas. Empecemos con la funci√≥n `as_date()`, que nos <mark>**convierte una cadena de texto en un dato de tipo fecha**</mark>.



```{r lubridate-package, echo = FALSE, fig.align = 'center',  include = identical(knitr:::pandoc_to(), 'html'), fig.link = 'https://lubridate.tidyverse.org/', out.width = '100%'}
knitr::include_graphics('img/lubridate.png')
```

```{r}
# install.packages("lubridate")
library(lubridate)
```

F√≠jate en la diferencia.

```{r}
# Fecha, mostrada como un texto pero guardada internamente como un n√∫mero
fecha_date <- as_date(fecha_char)
class(fecha_date)
fecha_date + 1 # d√≠a siguiente
fecha_date - 3 # 3 d√≠as antes
```

En el momento en que <mark>**convertimos la cadena de texto a fecha**</mark>, aunque se visualice como un texto, internamente es un n√∫mero, por lo que podemos restar fechas (d√≠as entre ambas), **podemos sumar n√∫meros a fechas** (fecha d√≠as despu√©s), etc. Como ya hemos dicho, **las fechas y momentos temporales no ser√°n meras cadenas de caracteres** sino que tienen clases especiales asociadas. Las fechas ser√°n guardadas internamente como el **n√∫mero de d√≠as transcurridos desde el 1 de enero de 1970**, y las horas como **n√∫mero de segundos desde el 1 de enero de 1970** (para la clase `POSIXct`) o una lista de segundos, minutos y horas (para la clase `POSIXlt`).

&nbsp;

La funci√≥n `as_date()` tiene un argumento opcional, el formato en la que le estamos la fecha, que por defecto ser√° `"yyyy-mm-dd"` (a√±o en 4 cifras, gui√≥n, mes en dos cifras, gui√≥n, d√≠a en dos cifras. Si <mark>**introducimos otro tipo de formato de fecha**</mark>, debemos especific√°rselo en un segundo argumento `format = ...`, para `R` sepa el formato de fecha que le estamos pasando

```{r}
as_date("10-03-2020", format = "%d-%m-%Y") # con d√≠a-mes-a√±o (4 cifras)
as_date("10-03-20", format = "%d-%m-%y")  # con d√≠a-mes-a√±o (2 cifras)
as_date("03-10-2020", format = "%m-%d-%Y") # con mes-d√≠a-a√±o (4 cifras)
as_date("Octubre 21, 1995 21:24", format = "%B %d, %Y %H:%M") # fecha escrita
``` 

&nbsp;

**`r colorize("ERROR: sin pasar a fecha no se puede operar", "#dc3545")`**

Si tenemos una fecha como caracter, nunca podremos hacer operaciones (por ejemplo, restarle una unidad temporal, en este caso un d√≠a).

```{r error = TRUE}
"2021-03-10" - 1 # error
```

F√≠jate la diferencia cuando lo convertimos en fecha

```{r error = TRUE}
fecha <- as_date("2021-03-10") - 1 # d√≠a previo
fecha
``` 


&nbsp;

## Funciones de lubridate

No solo podemos convertir la fecha con `as_date()`, indic√°ndole el formato. Para <mark>**facilitar conversiones de formatos habituales**</mark>, el paquete `{lubridate}` tiene a nuestra disposici√≥n diferentes funciones preparadas para directamente convertir fechas en distintos formatos, como la funci√≥n `ymd_hms()` o `ydm_hms()`

```{r}
ymd_hms("2017-11-28 14:02:00") # convertir a fecha una cadena a√±o-mes-d√≠a + hora
ydm_hms("2017-22-12 10:00:00") # convertir a fecha una cadena a√±o-d√≠a-mes + hora
```

De la misma manera tenemos la funci√≥n `dmy_hms()`
```{r}
dmy_hms("1 Jan 2017 23:59:59") # convertir a fecha una cadena textual de fecha + hora
```

Tambi√©n podemos hacerlo de forma muy simplifica con `mdy()` y `ymd()`

```{r}
mdy("July 4th, 2000") # convertir a fecha una cadena textual de fecha
ymd(20170131)
```

&nbsp; 

Otra de las funcionalidades que nos proporciona dicho paquetees <mark>**obtener autom√°ticamente la fecha de hoy**</mark>, haciendo uso de la funci√≥n `today()`

```{r}
hoy <- today()
class(hoy) # de clase fecha
hoy + 7 # dentro de una semana
``` 

Tambi√©n podemos <mark>**obtener el ¬´hoy y ahora¬ª**</mark> con la funci√≥n `now()`, obteniendo no solo la fecha sino la hora.


```{r}
now()
```


&nbsp;

Tambi√©n tenemos disponibles en dicho paquete funciones para extraer facilmente algunas variables temporales como el <mark>**d√≠a de la semana, el mes o el cuatrimestre**</mark>, con las funciones `year()`, `months()`, `day()`, `hour()`, `week()`, etc.

```{r}
fecha <- now()
year(fecha)
month(fecha)
day(fecha)
hour(fecha)
minute(fecha)
second(fecha)
week(fecha) # N√∫mero de semana (del a√±o)
``` 

Tambi√©n disponemos de la funci√≥n `wday()`, que nos devuelve el <mark>**d√≠a de la semana**</mark> en el que estamos (por defecto, la semana empieza el domingo, pero podemos cambiarlo con el argumento opcional `week_start = ...`)

```{r}
wday(fecha)
wday(fecha, week_start = 1) # D√≠a de la semana (empezando por el lunes)
```

Adem√°s si usamos otro argumento opcional `label = TRUE` (por defecto est√° en `FALSE`), nos convertir√° dichos d√≠as de la semana en los nombres (en lugar de n√∫meros)

```{r}
wday(fecha, week_start = 1, label = TRUE)
```

&nbsp;

Las funciones de `month()`, `year()`, `day()`, etc, pueden ser usadas tanto para extraer el valor como para cambiarlo, asign√°ndole uno distinto


```{r}
# Mantenemos la misma fecha que la actual pero solo cambiando el a√±o
year(fecha) <- 1891
```

&nbsp;

Al igual que podemos realizar operaciones aritm√©ticas sencillas con las fechas, tambi√©n podemos <mark>**realizar comparaciones**</mark>, por ejemplo, si el d√≠a actual es menor o mayor que otra fecha dada. 

```{r}
fecha_actual <- now()
fecha_actual > ymd(20170131) # Actual vs 2017-01-31
fecha_actual > ymd(21000131) # Actual vs 2100-01-31
``` 

&nbsp;

Con la funci√≥n `leap_year()` podremos saber si la fecha corresponde a un a√±o bisiesto

```{r}
leap_year(as_date(ymd(20190131)))
leap_year(as_date(ymd(20160131)))
```

Tambi√©n podemos hacer uso de diferentes funciones para a√±adir intervalos de tiempo a una fecha dada (que no sean solo d√≠as).

```{r}
fecha <- now()
fecha + weeks(0:3)
fecha + seconds(0:3)
```


## Consejos


**`r colorize("CONSEJOS", "#20935E")`**

&nbsp;

**`r colorize("Recuperar un comando y autocompletar", "#20935E")`**

Si haces click con el rat√≥n en la consola y pulsas la flecha ¬´arriba¬ª del teclado, te ir√° apareciendo todo el <mark>**historial de √≥rdenes ejecutadas**</mark>. Es una manera de ahorrar tiempo para ejecutar √≥rdenes similares a las ya ejecutadas. Si empiezas a escribir el nombre de una variable pero no te acuerdas exactamente de su nombre, pulsando **tabulador** te **autocompletar√°** solo.

&nbsp;

**`r colorize("Convertir tipos de datos",  "#20935E")`**

A veces la lectura de variables num√©ricas de nuestros archivos puede hacer que un n√∫mero, por ejemplo `1`, sea le√≠do como la cadena de texto `"1"`, con la que no podemos operar como un n√∫mero. Las funciones `as.numeric()`, `as.character()` y `as.logical()` nos permiten convertir una variable en tipo num√©rico, caracter o l√≥gico, respectivamente.

```{r error = TRUE}
"1" + 1
as.numeric("1") + 1
as.character(1)
as.logical(c(0, 1))
```

&nbsp;

## üìù Ejercicios

(haz click en las flechas para ver soluciones)

<details>
  <summary>üìù<strong>Ejercicio 1</strong>: obten la fecha de hoy, define la fecha de tu cumplea√±os, y calcula la diferencia de d√≠as. </summary>
  
<!-- toc -->
- Soluci√≥n:

```{r}
# Hoy
hoy <- today()

# Cumple (diferentes formatos de entrada)
cumple <- as_date("1989-09-10") # por defecto
cumple <- as_date("10-09-1989", format = "%d-%m-%Y")

# Diferencia
hoy - cumple
```

<!-- tocstop -->
</details>

&nbsp;

<details>
  <summary>üìù<strong>Ejercicio 2</strong>: define la fecha de tu cumplea√±os y determina si fue a√±o bisiesto. S√∫male 1-2-3-4-5 semanas. </summary>
  
<!-- toc -->
- Soluci√≥n:

```{r}
cumple <- as_date("1989-09-10") # por defecto

# Bisiesto
leap_year(cumple)

# Sumamos semanaes
cumple + weeks(1:5)
```

<!-- tocstop -->
</details>

&nbsp;


<details>
  <summary>üìù<strong>Ejercicio 3</strong>: extrae el mes, a√±o y d√≠a de la semana de tu cumplea√±os </summary>
  
<!-- toc -->
- Soluci√≥n:

```{r}
# Mes
month(cumple)

# A√±o 
year(cumple)

# wday
wday(cumple, week_start = 1)
wday(cumple, week_start = 1, label = TRUE)
```

<!-- tocstop -->
</details>

&nbsp;

<details>
  <summary>üìù<strong>Ejercicio 4</strong>: calcula los d√≠as que han pasado desde la fecha de tu nacimiento </summary>
  
<!-- toc -->
- Soluci√≥n:

```{r}
seconds(today() - cumple)
```

<!-- tocstop -->
</details>

&nbsp;
